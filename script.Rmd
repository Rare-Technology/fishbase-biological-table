---
title: "Fishbase Lmax-ab table"
output:
  html_notebook:
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE)

library(rfishbase)
library(dplyr)
library(tidyr)
```

In this notebook, we will compile a table of lmax and a/b coefficients using data from fishbase.

### Get taxonomy info
```{r}
fishbase_gensp <- rfishbase::load_taxa() %>% 
  dplyr::select(Family, Genus, Gensp = Species, speccode = SpecCode)
fishbase_gensp
```

### Get Lmax for all fish
Many of these will be missing and we will fill them in later by taking means across genus and families.
```{r}
suppressWarnings({
lmax_info <- rfishbase::length_length() %>% 
  dplyr::select(Gensp = Species, LengthMax) %>% 
  dplyr::mutate(lmax = as.numeric(LengthMax)) %>% 
  dplyr::group_by(Gensp) %>% 
  dplyr::summarize(Lmax = max(lmax, na.rm = TRUE)) %>%
  dplyr::mutate(Lmax = ifelse(is.infinite(Lmax), NA, Lmax)) %>% 
  tidyr::separate(Gensp, c('Genus', 'Species'), sep = ' ', remove = FALSE) %>% 
  dplyr::left_join(fishbase_gensp %>% 
    dplyr::select(Family, Gensp),
    by = "Gensp"
  )
})
lmax_info
```

### Take aggregate means and add it to the lmax table
```{r}
genus_Lmax_info <-  lmax_info %>% 
  dplyr::group_by(Genus) %>% 
  dplyr::summarize(genus_Lmax = mean(Lmax, na.rm = TRUE))

family_Lmax_info <- lmax_info %>% 
  dplyr::group_by(Family) %>% 
  dplyr::summarize(family_Lmax = mean(Lmax, na.rm = TRUE))

lmax_info <- lmax_info %>% 
  dplyr::select(Gensp, Lmax)

# Since we used summarize earlier, we lost some taxonomic info we'll need for joins
lmax_table <- dplyr::left_join(fishbase_gensp, lmax_info, by = 'Gensp') %>% 
  dplyr::left_join(genus_Lmax_info, by = "Genus") %>% 
  dplyr::left_join(family_Lmax_info, by = "Family")

# Fill in missing data
bio_table <- lmax_table %>% 
  dplyr::mutate(
    lmax = ifelse(is.na(Lmax),
      ifelse(is.na(genus_Lmax),
        family_Lmax,
        genus_Lmax
      ),
      Lmax
    )
  )

bio_table
```

### a/b table
Now we do the same process but for a/b coefficients. For this table, we only aggregate
up to the genus.
```{r}
ab_info <- rfishbase::poplw() %>% 
  dplyr::select(Gensp = Species, a, b) %>% 
  dplyr::group_by(Gensp) %>% 
  dplyr::summarize(
    a = mean(a, na.rm = TRUE),
    b = mean(b, na.rm = TRUE)
  ) %>% 
  tidyr::separate(Gensp, c("Genus", "Species"), sep = " ", remove = FALSE)

genus_ab_info <- ab_info %>% 
  dplyr::group_by(Genus) %>% 
  dplyr::summarize(
    genus_a = mean(a, na.rm = TRUE),
    genus_b = mean(b, na.rm = TRUE)
  )

ab_table <- ab_info %>%
  dplyr::left_join(genus_ab_info, by = "Genus")

ab_table <- ab_table %>% 
  dplyr::mutate(
    a = ifelse(is.na(a),
      genus_a,
      a
    ),
    b = ifelse(is.na(b),
      genus_b,
      b
    )
  )

ab_table
```

### Combine lmax and a/b tables
```{r}
bio_table <- dplyr::left_join(bio_table, ab_table, by = 'Gensp') %>% 
  dplyr::select(speccode, Gensp, Family, lmax, a, b)

bio_table
```

### Trophic levels
```{r}
species_info <- rfishbase::load_taxa() %>% 
  dplyr::select(speccode = SpecCode, Species, Genus, Family)

# Fill in missing genus info
# ourfish <- dplyr::left_join(ourfish, fishbase_genus_filter, by = "species_scientific") %>% 
#   dplyr::rename(genus_scientific = Genus)

family_troph <- rfishbase::ecology() %>% 
  dplyr::select(Species, DietTroph) %>% 
  dplyr::left_join(species_info, by = 'Species') %>% 
  dplyr::group_by(Family) %>% 
  dplyr::summarize(family_trophic_level = mean(DietTroph, na.rm = TRUE))

genus_troph <- rfishbase::ecology() %>% 
  dplyr::select(Species, DietTroph) %>% 
  dplyr::left_join(species_info, by = 'Species') %>% 
  dplyr::group_by(Genus) %>% 
  dplyr::summarize(genus_trophic_level = mean(DietTroph, na.rm = TRUE))

#### Dec 12 2022
# At least one species (Oreochromis niloticus) has more than one record when
# doing just dplyr::select from rfishbase::ecology. In the future there might
# be more species like this. So we do the same thing for genus and family:
# group by and average.
species_troph <- rfishbase::ecology() %>% 
  dplyr::select(Species, DietTroph) %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarize(species_trophic_level = mean(DietTroph, na.rm=TRUE))

trophic_table <- species_info %>% 
  dplyr::left_join(family_troph, by = "Family") %>% 
  dplyr::left_join(genus_troph, by = "Genus") %>% 
  dplyr::left_join(species_troph, by = "Species") %>% 
  dplyr::mutate(
    # Try to use the species trophic level.
    # If it's NA, use genus trophic level.
    # If that's NA, use family trophic level, which will then be used regardless if NA
    trophic_level = ifelse(is.na(species_trophic_level),
      ifelse(is.na(genus_trophic_level),
        family_trophic_level,
        genus_trophic_level
      ),
      species_trophic_level
    )
  ) %>% 
  dplyr::select(-c(
    family_trophic_level,
    genus_trophic_level,
    species_trophic_level
  ))

trophic_table
```

# Join trophic table with lmax/ab
```{r}
bio_table <- bio_table %>% 
  dplyr::left_join(
    trophic_table %>% 
      dplyr::rename(Gensp = Species) %>% 
      dplyr::select(Gensp, trophic_level),
    by = "Gensp"
  )

bio_table
```

### Update data.world file
```{r}
library(httr)
library(readr)

readr::write_csv(bio_table, "bio-table.csv")
DW_TOKEN <- Sys.getenv("DW_TOKEN")

# Saving output to res for debugging if necessary
res <- httr::PUT(
  url = "https://api.data.world/v0/uploads/rare/fishbase/files/bio-table.csv",
  config = httr::add_headers(
    Authorization = paste("Bearer", DW_TOKEN),
    "Content-Type" = "application/octet-stream"
  ),
  body = httr::upload_file("bio-table.csv")
)
```